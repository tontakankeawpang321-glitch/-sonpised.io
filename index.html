<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Tutor Connect | ‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            /* ‡∏ò‡∏µ‡∏°‡∏™‡∏µ: Royal Blue & Yellow (Amber) */
            --primary: #1e3a8a; 
            --primary-light: #1d4ed8; 
            --accent: #f59e0b; 
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
        }

        body { 
            font-family: 'Prompt', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
            letter-spacing: -0.01em;
            padding-bottom: 80px; /* ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ Bottom Nav */
        }

        body.no-scroll { overflow: hidden; }
        
        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        dialog {
            transition: opacity 0.15s ease, transform 0.15s ease;
            opacity: 0;
            transform: scale(0.98);
            border: none;
            outline: none;
            background-color: var(--bg-card);
            color: var(--text-main);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
            max-height: 90vh;
            max-width: 95vw;
            overscroll-behavior: contain;
        }
        dialog[open] { opacity: 1; transform: scale(1); }
        dialog::backdrop { background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); }
        
        .nav-solid { 
            background: rgba(255, 255, 255, 0.98); 
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        input, select, textarea {
            background-color: #ffffff !important;
            color: var(--text-main) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 0.5rem !important;
            box-shadow: none !important; 
            -webkit-appearance: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary) !important;
            outline: none;
            ring: 2px solid rgba(30, 58, 138, 0.1);
        }

        .field-error { border-color: #ef4444 !important; background-color: #fff1f2 !important; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .tutor-card {
            background: #ffffff;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            position: relative;
            overflow: hidden;
            content-visibility: auto; 
            contain-intrinsic-size: 300px;
            transition: transform 0.2s;
        }
        .tutor-card:hover { transform: translateY(-3px); border-color: var(--accent); }
        .tutor-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--primary);
            z-index: 10;
        }

        .icon-3d {
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Animation for Heart */
        @keyframes heartBeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        .heart-beat { animation: heartBeat 0.3s ease-in-out; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Navigation (Top) -->
<nav class="nav-solid sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
      <!-- Logo Area -->
      <div class="flex items-center gap-3 cursor-pointer select-none" onclick="refreshApp()">
        <div class="bg-blue-900 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-sm">
            <i class="fa-solid fa-user-graduate text-xl text-yellow-400 icon-3d"></i>
        </div>
        <div>
            <span class="font-bold text-lg text-blue-900 tracking-tight block leading-none font-serif">TutorConnect</span>
            <span class="text-[9px] text-blue-500 font-bold uppercase tracking-widest">Professional</span>
        </div>
      </div>
      
      <!-- Right Side Actions -->
      <div class="flex items-center gap-3">
         <!-- Desktop Filter -->
         <div class="hidden lg:flex bg-slate-100 p-1 rounded-lg border border-slate-200">
             <select id="filter_province_desktop" class="bg-transparent px-2 py-1.5 text-sm outline-none cursor-pointer border-r border-slate-200 text-slate-700 font-medium hover:text-blue-900 transition-colors mr-2">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (All)</option>
             </select>
             <div class="relative">
                 <input id="q_desktop" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." class="bg-transparent pl-8 pr-4 py-1.5 text-sm w-48 outline-none text-slate-800 border-none focus:ring-0 placeholder-slate-400 font-medium">
                 <i class="fa-solid fa-magnifying-glass absolute left-3 top-2 text-slate-400 text-xs"></i>
             </div>
         </div>

         <!-- Register Button (Desktop Only) -->
         <button onclick="openNewPostModal()" class="hidden lg:flex bg-yellow-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-[0_3px_0_rgb(180,130,0)] active:shadow-none active:translate-y-[3px] transition-all items-center gap-2 border border-yellow-600">
            <i class="fa-solid fa-plus text-xs drop-shadow-sm"></i> 
            <span>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span>
         </button>
      </div>
  </div>
</nav>

<!-- Mobile Filter Bar -->
<div class="lg:hidden bg-white border-b border-slate-200 px-4 py-3 sticky top-16 z-40 shadow-sm">
    <div class="flex gap-2 w-full">
        <select id="filter_province_mobile" class="border border-slate-300 rounded-lg px-2 py-0 text-xs bg-slate-50 outline-none w-[35%] font-medium text-slate-700 h-10">
            <option value="all">‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>
        </select>
        <div class="relative w-[65%]">
            <input id="q_mobile" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤, ‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå..." class="w-full pl-9 pr-3 py-0 bg-slate-50 border border-slate-300 rounded-lg text-xs outline-none text-slate-800 placeholder-slate-400 h-10 font-medium appearance-none">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400"></i>
        </div>
    </div>
</div>

<header class="bg-blue-900 text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-b from-blue-800 to-blue-950"></div>
    <div class="max-w-7xl mx-auto px-4 py-8 relative z-10">
        <div class="flex flex-col items-center text-center sm:items-start sm:text-left">
            <div class="inline-flex items-center gap-2 px-3 py-1 bg-white/10 rounded-full mb-4 border border-white/5 backdrop-blur-md">
                <div id="statusDot" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span class="text-[10px] font-bold text-blue-100 uppercase tracking-widest"><span id="countTutors" class="text-white text-xs mr-1">0</span> ‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≠‡∏ô</span>
            </div>
            <h1 class="text-3xl font-bold text-white tracking-tight leading-tight mb-2">
                ‡∏ó‡∏≥‡πÄ‡∏ô‡∏µ‡∏¢‡∏ö<span class="text-yellow-400 icon-3d">‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</span>‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û
            </h1>
            <p class="text-blue-200 text-xs font-light max-w-md leading-relaxed">
                ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏≤‡∏á‡πÉ‡∏à‡πÑ‡∏î‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
            </p>
        </div>
    </div>
</header>

<main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full relative z-20">
    <!-- Loader -->
    <div id="loading" class="flex flex-col items-center justify-center py-12 bg-white rounded-xl border border-slate-100 shadow-sm hidden">
        <div class="w-10 h-10 border-4 border-slate-200 border-t-blue-500 rounded-full animate-spin mb-3"></div>
        <p class="text-slate-400 text-[10px] font-bold tracking-widest uppercase">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
    
    <!-- Grid -->
    <section id="board" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 pb-8"></section>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-4 pb-12">
        <button onclick="changePage(-1)" id="btnPrev" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-500 active:bg-slate-100 disabled:opacity-30 shadow-sm"><i class="fa-solid fa-chevron-left"></i></button>
        <span id="pageIndicator" class="text-xs font-bold text-slate-500 font-mono">1 / 1</span>
        <button onclick="changePage(1)" id="btnNext" class="w-10 h-10 flex items-center justify-center rounded-lg bg-white border border-slate-200 text-slate-500 active:bg-slate-100 disabled:opacity-30 shadow-sm"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
</main>

<!-- Bottom Navigation (App Style) -->
<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 h-16 flex items-center justify-around z-50 lg:hidden shadow-[0_-4px_10px_rgba(0,0,0,0.03)] pb-safe">
    <button onclick="refreshApp()" class="flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-blue-900 active:text-blue-900 w-16 transition-colors">
        <i class="fa-solid fa-house text-xl mb-0.5"></i>
        <span class="text-[9px] font-bold">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
    </button>
    
    <button onclick="openNewPostModal()" class="flex flex-col items-center justify-center gap-1 w-16 group">
        <div class="w-12 h-12 bg-blue-900 rounded-full flex items-center justify-center shadow-lg shadow-blue-900/30 -mt-8 border-4 border-white text-white group-active:scale-95 transition-transform">
            <i class="fa-solid fa-plus text-xl"></i>
        </div>
        <span class="text-[9px] font-bold text-slate-500 group-hover:text-blue-900">‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</span>
    </button>
    
    <button onclick="openFavorites()" class="flex flex-col items-center justify-center gap-1 text-slate-400 hover:text-red-500 active:text-red-500 w-16 transition-colors">
        <div class="relative">
            <i class="fa-solid fa-heart text-xl mb-0.5"></i>
            <span id="navFavCount" class="absolute -top-1 -right-2 bg-red-500 text-white text-[8px] font-bold px-1 rounded-full hidden">0</span>
        </div>
        <span class="text-[9px] font-bold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</span>
    </button>
</nav>

<footer class="bg-blue-950 text-slate-500 py-8 px-4 border-t border-blue-900 text-center pb-24 lg:pb-8">
    <i class="fa-solid fa-certificate text-yellow-600 text-2xl mb-2 icon-3d"></i>
    <p class="text-[10px] uppercase tracking-widest text-slate-600 mb-4">Verified Professional Tutors</p>
    <p class="text-[10px]">¬© 2024 Tutor Connect Solution.</p>
</footer>

<!-- View Detail Dialog -->
<dialog id="viewDlg" class="w-full max-w-4xl p-0 rounded-xl overflow-hidden bg-white shadow-2xl">
    <div class="flex flex-col md:grid md:grid-cols-12 h-[80vh] md:h-[600px]">
        <!-- Image Section -->
        <div class="flex-none h-60 md:h-full md:col-span-7 bg-slate-900 relative">
            <div id="detailImageHero" class="w-full h-full relative">
                <img id="viewHeroImg" src="" class="w-full h-full object-cover" loading="lazy" onerror="handleImgError(this)">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent opacity-50"></div>
            </div>
            <div class="absolute bottom-0 left-0 right-0 p-3 bg-gradient-to-t from-slate-900 to-transparent">
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="viewImages"></div>
            </div>
            
            <div class="absolute top-3 right-3 flex gap-2 md:hidden z-20">
                <button id="btnDeletePostMobile" class="bg-black/30 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-red-600 transition-colors border border-white/10"><i class="fa-solid fa-trash-can text-xs"></i></button>
                <button onclick="closeViewModal()" class="bg-black/30 text-white w-8 h-8 rounded-full flex items-center justify-center backdrop-blur-sm border border-white/10"><i class="fa-solid fa-xmark text-sm"></i></button>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="flex-grow md:col-span-5 flex flex-col bg-white overflow-hidden">
            <div class="p-5 overflow-y-auto flex-grow">
                <div class="flex justify-between items-start mb-4">
                    <div class="px-2 py-1 bg-blue-50 text-blue-800 text-[10px] font-bold rounded border border-blue-200 uppercase tracking-wide">
                        <i class="fa-solid fa-check-circle text-blue-500 mr-1"></i> Verified
                    </div>
                    <div class="flex gap-2 hidden md:flex">
                        <button id="btnDeletePost" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button>
                        <button onclick="closeViewModal()" class="text-slate-400 hover:text-slate-900"><i class="fa-solid fa-xmark text-lg"></i></button>
                    </div>
                </div>

                <h2 id="viewTitle" class="text-lg font-bold text-slate-900 mb-2 leading-tight"></h2>
                
                <div class="flex items-center gap-3 mb-4 text-xs text-slate-500 border-b border-slate-100 pb-3">
                    <span id="viewProvince" class="flex items-center gap-1"><i class="fa-solid fa-location-dot text-blue-500"></i> <span class="truncate"></span></span>
                    <span id="viewAddress" class="flex items-center gap-1 truncate"><i class="fa-solid fa-map-pin"></i> <span></span></span>
                </div>

                <div class="bg-slate-50 rounded-lg p-3 border border-slate-100 mb-4">
                    <p class="text-[9px] text-slate-400 uppercase font-bold tracking-wider mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
                    <div class="flex items-baseline gap-1">
                        <span id="viewPrice" class="text-2xl font-bold text-slate-900 font-mono"></span>
                        <span class="text-xs text-slate-500">THB / ‡∏ä‡∏°.</span>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="text-[10px] font-bold text-slate-900 uppercase mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h4>
                    <div id="viewBody" class="text-xs text-slate-600 leading-relaxed whitespace-pre-line"></div>
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-4 border-t border-slate-100 bg-white flex-none sticky bottom-0">
                <div class="flex justify-between items-center text-xs mb-3">
                    <span class="text-slate-400 font-bold">‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå:</span>
                    <div class="text-right">
                        <div id="viewContact" class="font-bold text-slate-800 leading-tight"></div>
                        <div class="flex flex-col items-end gap-1 mt-1">
                            <!-- ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏ö‡∏ö Text Link -->
                            <a id="viewPhoneShow" href="#" class="text-[10px] text-blue-600 hover:text-blue-800 font-mono font-bold tracking-wider underline underline-offset-4"></a>
                            <!-- Line ID ‡πÅ‡∏ö‡∏ö Text Link -->
                            <a id="viewLineShow" href="#" target="_blank" class="text-[10px] text-emerald-600 hover:text-emerald-800 font-mono font-bold tracking-wider underline underline-offset-4"></a>
                        </div>
                    </div>
                </div>
                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏≠‡∏≠‡∏Å‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå -->
                <a id="btnCall" href="#" class="w-full bg-blue-900 hover:bg-blue-800 text-white py-3 rounded-lg font-bold text-sm shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <i class="fa-solid fa-phone text-yellow-400 icon-3d"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå
                </a>
            </div>
        </div>
    </div>
</dialog>

<!-- Favorites Dialog -->
<dialog id="favDlg" class="w-full max-w-lg p-0 rounded-xl overflow-hidden bg-white shadow-2xl h-[80vh] sm:h-auto">
    <div class="flex flex-col h-full">
        <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-none">
            <h3 class="text-base font-bold text-slate-900 flex items-center gap-2">
                <i class="fa-solid fa-heart text-red-500 icon-3d"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            </h3>
            <button onclick="closeFavorites()" class="text-slate-400 hover:text-slate-900 w-8 h-8 rounded-full active:bg-slate-50"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        <div class="p-4 overflow-y-auto flex-grow bg-slate-50">
            <div id="favList" class="grid grid-cols-2 gap-3"></div>
            <div id="favEmpty" class="hidden flex flex-col items-center justify-center h-full text-slate-400 py-10">
                <i class="fa-regular fa-heart text-4xl mb-3 opacity-30"></i>
                <p class="text-xs">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î</p>
            </div>
        </div>
    </div>
</dialog>

<!-- Registration Dialog -->
<dialog id="dlg" class="w-full max-w-lg p-0 rounded-xl overflow-hidden bg-white shadow-2xl h-[90vh] sm:h-auto">
    <div class="flex flex-col h-full">
        <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white flex-none">
            <h3 id="dlgTitle" class="text-base font-bold text-slate-900 flex items-center gap-2">
                <i class="fa-solid fa-user-plus text-blue-500 icon-3d"></i> ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå
            </h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-900 w-8 h-8 rounded-full active:bg-slate-50"><i class="fa-solid fa-xmark text-lg"></i></button>
        </div>
        
        <div class="p-5 overflow-y-auto flex-grow bg-slate-50 space-y-5">
            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm space-y-3">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h4>
                <input id="title" type="text" class="w-full px-3 py-2 text-sm border-slate-200" placeholder="‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏≠‡∏ô *">
                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <select id="input_province" class="w-full px-3 py-2 text-sm border-slate-200 bg-white"><option value="">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</option></select>
                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[9px] text-slate-300 pointer-events-none"></i>
                    </div>
                    <div class="relative">
                        <input id="price" type="number" class="w-full pl-3 pr-8 py-2 text-sm border-slate-200" placeholder="‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏ô / ‡∏ä‡∏°. *">
                        <span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">‡∏ø</span>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm space-y-3">
                <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h4>
                <div class="grid grid-cols-2 gap-3">
                    <input id="contact_name" type="text" class="w-full px-3 py-2 text-sm border-slate-200" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå">
                    <input id="phone" type="tel" class="w-full px-3 py-2 text-sm border-slate-200" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ *">
                </div>
                <!-- ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° Line ID -->
                <div class="relative">
                    <input id="line_id" type="text" class="w-full pl-8 pr-3 py-2 text-sm border-slate-200" placeholder="Line ID">
                    <i class="fa-brands fa-line absolute left-3 top-2.5 text-emerald-500"></i>
                </div>
                <input id="address" type="text" class="w-full px-3 py-2 text-sm border-slate-200" placeholder="‡∏¢‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡∏™‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏¢‡∏≤‡∏°, ‡πÅ‡∏ô‡∏ß BTS)">
                <textarea id="body" rows="3" class="w-full px-3 py-2 text-sm border-slate-200 resize-none" placeholder="‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô..."></textarea>
            </div>
        
            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 3)</h4>
                    <span id="imgCount" class="text-[9px] text-slate-400">0/3</span>
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div id="previewList" class="contents"></div>
                    <label id="uploadBtn" class="aspect-square border border-dashed border-slate-300 rounded bg-slate-50 flex flex-col items-center justify-center text-slate-400 active:bg-slate-100 cursor-pointer">
                        <i class="fa-solid fa-camera text-sm"></i>
                        <input id="img" type="file" class="hidden" accept="image/*" multiple onchange="appendImages(this)">
                    </label>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-100 bg-white flex-none flex gap-3">
            <button onclick="closeModal()" class="px-4 py-2 text-slate-500 font-bold text-xs rounded-lg border border-slate-200">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="savePost()" id="btnSave" class="flex-1 bg-yellow-500 text-white py-2 rounded-lg font-bold text-sm shadow-[0_3px_0_rgb(180,130,0)] active:shadow-none active:translate-y-[3px] transition-all">
                <span id="btnSaveText">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</span> 
            </button>
        </div>
    </div>
</dialog>

<!-- Image Slider -->
<div id="imageSlider" class="fixed inset-0 z-[100] bg-black hidden flex-col items-center justify-center">
    <button onclick="closeImageSlider()" class="absolute top-4 right-4 text-white w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm"><i class="fa-solid fa-xmark"></i></button>
    <div class="w-full h-full flex items-center justify-center p-2">
        <button onclick="changeSlide(-1)" class="absolute left-2 text-white w-10 h-10 bg-black/50 rounded-full"><i class="fa-solid fa-chevron-left"></i></button>
        <img id="sliderMainImage" src="" class="max-w-full max-h-[90vh] object-contain shadow-2xl rounded-lg">
        <button onclick="changeSlide(1)" class="absolute right-2 text-white w-10 h-10 bg-black/50 rounded-full"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
    <div class="absolute bottom-6 text-white text-[10px] bg-blue-900/50 px-4 py-2 rounded-full font-mono tracking-widest backdrop-blur-sm"><span id="sliderCounter"></span></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz2YS70cqQL6ELVYBeIWF2FOerHqC4MiUghgptsVZshL_hRJwPabC6Pxfa1_PKXOChzGw/exec"; 
const PROVINCES = ["‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó", "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤", "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå", "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå", "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£", "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π", "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ"].sort();

let posts = [], filteredPosts = [], currentPage = 1, formImages = [], sliderImages = [], sliderIndex = 0;
// Favorites Logic
let favorites = JSON.parse(localStorage.getItem('tutor_favorites') || '[]');

const ITEMS_PER_PAGE = 15; 
const CACHE_KEY = 'tutor_connect_posts_cache_v5_line';

const dom = {
    loading: document.getElementById('loading'),
    board: document.getElementById('board'),
    pageIndicator: document.getElementById('pageIndicator'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    dlg: document.getElementById('dlg'),
    viewDlg: document.getElementById('viewDlg'),
    favDlg: document.getElementById('favDlg'), // Favorites Dialog
    favList: document.getElementById('favList'),
    favEmpty: document.getElementById('favEmpty'),
    navFavCount: document.getElementById('navFavCount'),
    btnSaveText: document.getElementById('btnSaveText'),
    title: document.getElementById('title'),
    price: document.getElementById('price'),
    province: document.getElementById('input_province'),
    contactName: document.getElementById('contact_name'),
    phone: document.getElementById('phone'),
    lineId: document.getElementById('line_id'), 
    address: document.getElementById('address'),
    body: document.getElementById('body'),
    imgPreview: document.getElementById('previewList'),
    imgCount: document.getElementById('imgCount'),
    uploadBtn: document.getElementById('uploadBtn'),
    filterDesktop: document.getElementById('filter_province_desktop'),
    filterMobile: document.getElementById('filter_province_mobile'),
    qDesktop: document.getElementById('q_desktop'),
    qMobile: document.getElementById('q_mobile'),
    slider: document.getElementById('imageSlider'),
    sliderImg: document.getElementById('sliderMainImage'),
    sliderCount: document.getElementById('sliderCounter'),
    viewHero: document.getElementById('viewHeroImg'),
    countTutors: document.getElementById('countTutors'),
    statusDot: document.getElementById('statusDot')
};

function handleImgError(img) { img.src = 'https://placehold.co/600x400/f8fafc/e2e8f0?text=TutorConnect'; }
function setScrollLock(lock) { document.body.classList.toggle('no-scroll', lock); }

function init() {
    populateProvinces();
    updateFavCount();
    loadPosts();
    [dom.qDesktop, dom.qMobile].forEach(el => el.addEventListener('input', debounce(applyFilters, 400)));
    
    if(dom.filterDesktop) dom.filterDesktop.addEventListener('change', (e) => {
        dom.filterDesktop.value = dom.filterMobile.value = e.target.value;
        applyFilters();
    });
    dom.filterMobile.addEventListener('change', (e) => {
        if(dom.filterDesktop) dom.filterDesktop.value = dom.filterMobile.value = e.target.value;
        applyFilters();
    });
}

function populateProvinces() {
    const html = PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
    dom.province.innerHTML = `<option value="">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î *</option>${html}`;
    dom.filterDesktop.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (All)</option>${html}`;
    dom.filterMobile.innerHTML = `<option value="all">‡∏ó‡∏∏‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</option>${html}`;
}

async function loadPosts() {
    const cached = localStorage.getItem(CACHE_KEY);
    if (cached) {
        posts = JSON.parse(cached);
        applyFilters();
    }

    if(dom.loading && posts.length === 0) dom.loading.classList.remove('hidden');

    try {
        const res = await fetch(`${API_URL}?t=${Date.now()}`);
        if (!res.ok) throw new Error('API Error');
        const data = await res.json();
        const rawPosts = (Array.isArray(data) ? data : data.data || []);
        
        posts = rawPosts.map(p => {
            let imgs = [];
            try {
              if (Array.isArray(p.images)) imgs = p.images;
              else if (typeof p.images === 'string') {
                const s = p.images.trim();
                if (s.startsWith('[')) imgs = JSON.parse(s);
                else if (s.startsWith('http')) imgs = [s];
              }
            } catch { imgs = []; }

            const processedImages = imgs
              .filter(u => typeof u === 'string' && u.includes('google'))
              .map(u => {
                if (u.includes('/d/') && !u.includes('=')) return u + '=s1000';
                if (u.includes('id=')) {
                  const id = u.split('id=')[1].split('&')[0];
                  return `https://lh3.googleusercontent.com/d/${id}=s1000`;
                }
                return u;
              });
            return { ...p, images: processedImages };
        }).reverse();

        localStorage.setItem(CACHE_KEY, JSON.stringify(posts));
        if(dom.countTutors) dom.countTutors.textContent = posts.length;
        if(dom.statusDot) {
            dom.statusDot.classList.replace('bg-gray-400', 'bg-emerald-500');
            dom.statusDot.classList.add('animate-pulse');
        }
        applyFilters();
    } catch (e) {
        if(dom.statusDot) dom.statusDot.classList.replace('bg-gray-400', 'bg-red-500');
    } finally {
        if(dom.loading) dom.loading.classList.add('hidden');
    }
}

function applyFilters() {
    const q = (dom.qDesktop.value || dom.qMobile.value).toLowerCase();
    const prov = dom.filterDesktop.value;
    
    filteredPosts = posts.filter(p => {
        const matchText = (String(p.title)+String(p.body)).toLowerCase().includes(q);
        const matchProv = prov === 'all' || p.province === prov;
        return matchText && matchProv;
    });
    currentPage = 1;
    renderBoard();
}

// Favorites Functions
function toggleFavorite(id) {
    const strId = String(id);
    const index = favorites.indexOf(strId);
    if (index === -1) {
        favorites.push(strId);
    } else {
        favorites.splice(index, 1);
    }
    localStorage.setItem('tutor_favorites', JSON.stringify(favorites));
    updateFavCount();
    
    // Update Icons
    const icon = document.getElementById(`fav-icon-${strId}`);
    if (icon) {
        icon.className = `${favorites.includes(strId) ? 'fa-solid text-red-500 heart-beat' : 'fa-regular text-slate-400'} fa-heart text-sm`;
    }
    
    // Refresh Fav Dialog if open
    if (dom.favDlg.open) renderFavorites();
}

function isFavorite(id) {
    return favorites.includes(String(id));
}

function updateFavCount() {
    if(dom.navFavCount) {
        dom.navFavCount.textContent = favorites.length;
        dom.navFavCount.classList.toggle('hidden', favorites.length === 0);
    }
}

function openFavorites() {
    renderFavorites();
    dom.favDlg.showModal();
    setScrollLock(true);
}

function closeFavorites() {
    dom.favDlg.close();
    setScrollLock(false);
}

function renderFavorites() {
    const favPosts = posts.filter(p => favorites.includes(String(p.id)));
    dom.favList.innerHTML = '';
    
    if (favPosts.length === 0) {
        dom.favEmpty.classList.remove('hidden');
        dom.favList.classList.add('hidden');
    } else {
        dom.favEmpty.classList.add('hidden');
        dom.favList.classList.remove('hidden');
        
        favPosts.forEach(p => {
            const thumb = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/400x500/f1f5f9/cbd5e1?text=TutorConnect';
            const el = document.createElement('div');
            el.className = "bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm relative";
            el.onclick = () => viewDetail(p.id);
            el.innerHTML = `
                <div class="aspect-square bg-slate-100 relative">
                    <img src="${thumb}" class="w-full h-full object-cover">
                    <button class="absolute top-1 right-1 w-6 h-6 bg-white/80 rounded-full flex items-center justify-center" onclick="event.stopPropagation(); toggleFavorite('${p.id}')">
                        <i class="fa-solid fa-heart text-red-500 text-xs"></i>
                    </button>
                </div>
                <div class="p-2">
                    <h4 class="text-[10px] font-bold text-slate-800 line-clamp-1">${p.title}</h4>
                    <div class="text-[9px] text-blue-600 font-bold mt-1">‡∏ø${Number(p.price).toLocaleString()}</div>
                </div>
            `;
            dom.favList.appendChild(el);
        });
    }
}

function renderBoard() {
    dom.board.innerHTML = '';
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const items = filteredPosts.slice(start, start + ITEMS_PER_PAGE);
    
    if (items.length === 0) {
        dom.board.innerHTML = `<div class="col-span-full py-20 text-center text-slate-400 text-xs italic tracking-widest">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>`;
    } else {
        items.forEach(p => {
            const thumb = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/400x500/f1f5f9/cbd5e1?text=TutorConnect';
            const card = document.createElement('div');
            card.className = "tutor-card rounded-lg overflow-hidden cursor-pointer flex flex-col group border border-slate-100 shadow-sm";
            card.onclick = () => viewDetail(p.id);
            card.innerHTML = `
                <div class="aspect-[4/5] bg-slate-100 relative overflow-hidden">
                    <img src="${thumb}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy" onerror="this.src='https://placehold.co/400x500/f1f5f9/cbd5e1?text=TutorConnect'">
                    
                    <button class="absolute top-2 right-2 z-20 w-8 h-8 rounded-full bg-white/80 backdrop-blur-sm flex items-center justify-center shadow-sm transition-all active:scale-95 hover:bg-white" onclick="event.stopPropagation(); toggleFavorite('${p.id}')">
                        <i class="${isFavorite(p.id) ? 'fa-solid text-red-500' : 'fa-regular text-slate-400'} fa-heart text-sm" id="fav-icon-${p.id}"></i>
                    </button>

                    <div class="absolute bottom-2 left-2 flex flex-wrap gap-1">
                        <span class="bg-blue-900/90 backdrop-blur-sm text-white px-1.5 py-0.5 rounded text-[8px] font-bold uppercase border border-blue-800">${p.province}</span>
                    </div>
                </div>
                <div class="p-3 flex flex-col flex-grow bg-white">
                    <h3 class="font-bold text-blue-950 text-[12px] line-clamp-2 leading-snug h-8 mb-2 group-hover:text-blue-600 transition-colors">${p.title}</h3>
                    <div class="mt-auto pt-2 border-t border-slate-50 flex items-center justify-between">
                        <div class="flex items-baseline gap-0.5">
                            <span class="text-blue-900 font-black text-xs">‡∏ø${Number(p.price).toLocaleString()}</span>
                            <span class="text-[8px] text-slate-400">/‡∏ä‡∏°.</span>
                        </div>
                        <i class="fa-solid fa-arrow-right-long text-[9px] text-slate-200 group-hover:text-yellow-500 group-hover:translate-x-1 transition-all"></i>
                    </div>
                </div>
            `;
            dom.board.appendChild(card);
        });
    }
    updatePagination();
}

function updatePagination() {
    const total = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE) || 1;
    dom.pageIndicator.textContent = `${currentPage} / ${total}`;
    dom.btnPrev.disabled = currentPage === 1;
    dom.btnNext.disabled = currentPage === total;
}

function changePage(delta) { currentPage += delta; renderBoard(); window.scrollTo({ top: 0, behavior: 'auto' }); }
function openNewPostModal() { resetForm(); dom.dlg.showModal(); setScrollLock(true); }
function closeModal() { dom.dlg.close(); setScrollLock(false); }

function viewDetail(id) {
    const p = posts.find(x => x.id == id);
    if (!p) return;
    
    dom.viewHero.src = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/600x400/f1f5f9/cbd5e1?text=No+Image';
    document.getElementById('viewTitle').textContent = p.title;
    document.getElementById('viewPrice').textContent = Number(p.price).toLocaleString();
    document.getElementById('viewContact').textContent = p.contact_name || '‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå';
    
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (Phone Links) 
    const rawPhone = String(p.phone || '').trim();
    const cleanPhone = rawPhone.replace(/[^0-9+]/g, ''); 
    const telLink = cleanPhone ? `tel:${cleanPhone}` : '#';
    
    // ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Line ID
    const rawLine = String(p.line_id || '').trim();
    const lineLink = rawLine ? `https://line.me/ti/p/~${rawLine}` : '#';
    
    const phoneShow = document.getElementById('viewPhoneShow');
    const lineShow = document.getElementById('viewLineShow');
    const btnCall = document.getElementById('btnCall');
    
    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£
    if (phoneShow) {
        phoneShow.textContent = rawPhone ? `üìû ${rawPhone}` : '';
        phoneShow.href = telLink;
        phoneShow.parentElement.parentElement.style.display = (rawPhone || rawLine) ? 'block' : 'none';
    }

    // ‡πÅ‡∏™‡∏î‡∏á Line ID
    if (lineShow) {
        lineShow.textContent = rawLine ? `üíö Line ID: ${rawLine}` : '';
        lineShow.href = lineLink;
        lineShow.style.display = rawLine ? 'block' : 'none';
    }

    document.getElementById('viewProvince').querySelector('span').textContent = p.province;
    document.getElementById('viewAddress').querySelector('span').textContent = p.address || '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏ï‡∏Å‡∏•‡∏á';
    document.getElementById('viewBody').textContent = p.body || '-';
    
    if (btnCall) {
        btnCall.href = telLink;
        btnCall.style.display = cleanPhone ? 'flex' : 'none';
    }
    
    const imgBox = document.getElementById('viewImages');
    imgBox.innerHTML = '';
    sliderImages = p.images || [];
    sliderImages.forEach((url, i) => {
        const img = document.createElement('img');
        img.src = url;
        img.className = `h-10 w-14 rounded object-cover border border-slate-200 cursor-pointer flex-shrink-0 ${i===0?'ring-2 ring-yellow-400':''}`;
        img.onclick = (e) => { e.stopPropagation(); openSlider(i); };
        imgBox.appendChild(img);
    });

    document.getElementById('btnDeletePost').onclick = (e) => { e.stopPropagation(); confirmDelete(p.id); };
    const btnDeleteMobile = document.getElementById('btnDeletePostMobile');
    if(btnDeleteMobile) btnDeleteMobile.onclick = (e) => { e.stopPropagation(); confirmDelete(p.id); };

    if (dom.viewDlg.open) dom.viewDlg.close();
    dom.viewDlg.showModal();
    setScrollLock(true);
}

function closeViewModal() { dom.viewDlg.close(); setScrollLock(false); }

async function confirmDelete(id) {
    closeViewModal(); 
    const res = await Swal.fire({ 
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®?', 
        icon: 'warning', 
        showCancelButton: true, 
        confirmButtonColor: '#1e3a8a', 
        confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' 
    });
    if (res.isConfirmed) {
        Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        try {
            await fetch(API_URL, { 
                method: 'POST', 
                mode: 'no-cors',
                body: JSON.stringify({ action: 'delete', id: id }) 
            });
            setTimeout(() => { loadPosts(); Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', timer: 1000, showConfirmButton: false }); }, 1000);
        } catch (e) { Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error'); }
    }
}

function appendImages(input) {
    const files = Array.from(input.files);
    files.slice(0, 3 - formImages.length).forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => { formImages.push(e.target.result); renderPreview(); };
        reader.readAsDataURL(file);
    });
}

function renderPreview() {
    dom.imgPreview.innerHTML = '';
    formImages.forEach((src, i) => {
        const div = document.createElement('div');
        div.className = "relative aspect-square rounded overflow-hidden border border-slate-200 shadow-sm";
        div.innerHTML = `<img src="${src}" class="w-full h-full object-cover">
            <button onclick="removeImg(${i})" class="absolute top-1 right-1 bg-red-500 text-white w-4 h-4 rounded-full flex items-center justify-center text-[8px]"><i class="fa-solid fa-xmark"></i></button>`;
        dom.imgPreview.appendChild(div);
    });
    dom.imgCount.textContent = `${formImages.length}/3`;
    dom.uploadBtn.classList.toggle('hidden', formImages.length >= 3);
}

function removeImg(i) { formImages.splice(i, 1); renderPreview(); }

async function savePost() {
    const validations = [dom.title, dom.price, dom.province, dom.phone];
    let ok = true;
    validations.forEach(el => {
        if (!el.value.trim()) { el.classList.add('field-error'); ok = false; }
        else el.classList.remove('field-error');
    });
    if (!ok) return Swal.fire({ icon: 'error', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*)', timer: 1500, showConfirmButton: false });

    // ‚úÖ ‡∏õ‡∏¥‡∏î Dialog ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    closeModal();
    // ‡πÅ‡∏™‡∏î‡∏á SweetAlert ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    Swal.fire({
        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    try {
        await fetch(API_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({
                action: 'add', id: Date.now(), title: dom.title.value, price: Number(dom.price.value), 
                province: dom.province.value, district: "", address: dom.address.value, 
                contact_name: dom.contactName.value, phone: dom.phone.value, 
                line_id: dom.lineId.value, // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Line ID ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Backend
                body: dom.body.value, 
                images: formImages
            })
        });
        Swal.fire({ title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ï‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', icon: 'success', timer: 2000, showConfirmButton: false });
        setTimeout(() => loadPosts(), 1500);
    } catch (e) { 
        Swal.fire('Error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error'); 
    } 
}

function openSlider(i) {
    sliderIndex = i;
    dom.sliderImg.src = sliderImages[i];
    dom.sliderCount.textContent = `${i + 1} / ${sliderImages.length}`;
    if(dom.viewDlg.open) dom.viewDlg.close();
    dom.slider.classList.remove('hidden'); dom.slider.classList.add('flex');
    setScrollLock(true);
}

function closeImageSlider() { 
    dom.slider.classList.add('hidden'); 
    dom.slider.classList.remove('flex'); 
    dom.viewDlg.showModal();
}

function changeSlide(n) {
    sliderIndex = (sliderIndex + n + sliderImages.length) % sliderImages.length;
    dom.sliderImg.src = sliderImages[sliderIndex];
    dom.sliderCount.textContent = `${sliderIndex + 1} / ${sliderImages.length}`;
}

function debounce(fn, t) { let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), t); }; }

function resetForm() {
    dom.title.value = dom.price.value = dom.province.value = dom.contactName.value = dom.phone.value = dom.lineId.value = dom.address.value = dom.body.value = '';
    formImages = []; renderPreview();
    [dom.title, dom.price, dom.province, dom.phone].forEach(el => el.classList.remove('field-error'));
}

function refreshApp() {
    dom.qDesktop.value = dom.qMobile.value = dom.filterDesktop.value = dom.filterMobile.value = 'all';
    loadPosts();
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

init();
</script>
</body>
</html>
